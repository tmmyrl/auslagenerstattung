<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auslagenerstattung Hole of Fame e.V.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Modern Indigo -->
    <!-- Application Structure Plan: A task-oriented, single-page form application. The structure guides the user logically from personal details to itemized expenses, with dynamic table rows for easy entry. An automatically calculated total provides immediate feedback. The final step is a clear call-to-action to print the form. This structure was chosen to streamline the data entry process, minimize user error by automating calculations, and provide a clean, print-ready output, directly addressing the core task of submitting an expense claim efficiently. -->
    <!-- Visualization & Content Choices: Report Info: Expense items -> Goal: Organize/Collect -> Presentation: Interactive HTML Table -> Interaction: Add/Delete rows via JS, real-time sum calculation, and a new LLM-powered feature to parse natural language descriptions into table rows -> Justification: A table is the most intuitive way to present itemized data. Dynamic rows and auto-calculation are significant usability improvements over a static form, and the LLM feature adds a powerful, time-saving "magic" element. Library/Method: Vanilla JS for all interactions and Gemini API for the LLM feature. Report Info: Total sum -> Goal: Inform -> Presentation: Read-only display field -> Interaction: Updates automatically -> Justification: Provides immediate, error-free feedback to the user. Library/Method: Vanilla JS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        @page {
            size: A4;
            margin: 1cm;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-input {
            @apply w-full rounded-md border border-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm;
        }
        .btn {
            @apply inline-flex items-center justify-center rounded-md border border-transparent px-4 py-2 text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300 focus:ring-gray-400;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
        }
        @media print {
            .no-print {
                display: none;
            }
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                height: 29.7cm;
                width: 21cm;
                margin: 0;
                padding: 1cm;
            }
            .print-container {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
                height: 100%;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-8 rounded-xl shadow-lg print-container">
            
            <header class="mb-8 text-center">
                <h1 class="text-2xl font-bold text-gray-900 sm:text-3xl">Auslagenerstattung</h1>
                <div id="verein-info" class="mt-2 text-sm text-gray-600">
                    <p class="font-semibold">Hole of Fame e.V.</p>
                    <p>Königsbrücker Str. 39, 01099 Dresden</p>
                </div>
            </header>

            <main>
                <form id="reimbursement-form">
                    <section id="applicant-details" class="mb-8">
                        <h2 class="text-lg font-semibold border-b pb-2 mb-4 text-gray-700">Deine Angaben</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="name" class="form-input mt-1">
                            </div>
                            <div>
                                <label for="address" class="block text-sm font-medium text-gray-700">Anschrift</label>
                                <textarea id="address" class="form-input mt-1 resize-y min-h-[50px]"></textarea>
                            </div>
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Datum</label>
                                <input type="date" id="date" class="form-input mt-1">
                            </div>
                        </div>
                    </section>
                    
                    <section id="expense-items" class="mb-8">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center border-b pb-2 mb-4">
                             <h2 class="text-lg font-semibold text-gray-700">Aufstellung deiner Ausgaben</h2>
                             <div class="flex gap-2 mt-2 sm:mt-0 no-print">
                                <button type="button" id="add-row" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                    Posten hinzufügen
                                </button>
                                <button type="button" id="generate-items" class="btn btn-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a8 8 0 100 16A8 8 0 0010 2zm-1.872 7.757l-1.414 1.414a1 1 0 000 1.414l2.121 2.121a1 1 0 001.414 0l1.414-1.414a1 1 0 000-1.414l-2.121-2.121a1 1 0 00-1.414 0zM10.707 6.293a1 1 0 00-1.414 0l-1.414 1.414a1 1 0 000 1.414l2.121 2.121a1 1 0 001.414 0l1.414-1.414a1 1 0 000-1.414l-2.121-2.121zM10 1a9 9 0 110 18 9 9 0 010-18zm-2.828 7.757l-1.414 1.414a1 1 0 000 1.414l2.121 2.121a1 1 0 001.414 0l1.414-1.414a1 1 0 000-1.414l-2.121-2.121a1 1 0 00-1.414 0z" /></svg>
                                    Ausgaben generieren
                                </button>
                             </div>
                        </div>
                        <p class="text-sm text-gray-500 mb-4 no-print">Füge hier alle Ausgaben hinzu. Die Gesamtsumme wird automatisch berechnet.</p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Datum</th>
                                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Beschreibung & Zweck</th>
                                        <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Betrag (€)</th>
                                        <th class="w-16 py-2 px-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Aktion</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-table-body">
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section id="summary" class="mb-8 flex justify-end">
                        <div class="flex items-center gap-4">
                            <label for="total-amount" class="text-lg font-semibold text-gray-700">Gesamtsumme:</label>
                            <input type="text" id="total-amount" class="form-input w-32 text-right font-bold text-lg bg-gray-100" readonly value="0.00 €">
                        </div>
                    </section>

                    <section id="bank-details" class="mb-8">
                         <h2 class="text-lg font-semibold border-b pb-2 mb-4 text-gray-700">Bankverbindung für die Erstattung</h2>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="iban" class="block text-sm font-medium text-gray-700">IBAN</label>
                                <input type="text" id="iban" class="form-input mt-1 w-full" maxlength="30" placeholder="DE00 0000 0000 0000 0000 00">
                            </div>
                            <div>
                                <label for="bank-name" class="block text-sm font-medium text-gray-700">Name der Bank</label>
                                <input type="text" id="bank-name" class="form-input mt-1">
                            </div>
                        </div>
                    </section>

                    <section id="declaration" class="mt-12 pt-8 border-t-2 border-dashed">
                        <p class="text-sm text-gray-600 mb-8">
                            Ich bestätige hiermit, dass die oben aufgeführten Ausgaben ausschließlich im Sinne und zum Wohle des Vereins getätigt wurden. Ich versichere, dass meine Angaben korrekt und vollständig sind. Bitte füge diesem Formular alle Originalbelege bei. Ohne Belege ist eine Erstattung nicht möglich.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-16">
                            <div class="border-t border-gray-400 pt-2">
                                <p class="text-sm text-gray-700">Unterschrift Mitglied</p>
                            </div>
                             <div class="border-t border-gray-400 pt-2">
                                <p class="text-sm text-gray-700">Unterschrift Vorstand / Kassenwart (Freigabe)</p>
                            </div>
                        </div>
                    </section>
                </form>

                <footer class="mt-12 text-center no-print">
                    <div class="flex justify-center gap-4">
                        <button type="button" id="print-form" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                            Formular drucken
                        </button>
                        <button type="button" id="reset-form" class="btn btn-secondary">Formular zurücksetzen</button>
                    </div>
                </footer>
            </main>
        </div>
    </div>

    <!-- Generieren Modal -->
    <div id="generate-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 class="text-lg font-bold text-gray-900">Ausgaben automatisch generieren ✨</h3>
                <span id="close-modal" class="text-xl font-bold text-gray-600 cursor-pointer hover:text-gray-900">&times;</span>
            </div>
            <div class="py-4">
                <p class="text-sm text-gray-700 mb-4">Beschreibe deine Ausgaben einfach in einem Satz und ich fülle die Tabelle für dich aus. Zum Beispiel: "Ich habe 30,50€ für neue Lautsprecherkabel gekauft, 15€ für die Druckkosten der Flyer und 5€ für Briefmarken."</p>
                <textarea id="prompt-textarea" rows="4" class="form-input" placeholder="Deine Ausgaben..."></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" id="generate-submit" class="btn btn-primary">
                    <span id="generate-btn-text">Generieren</span>
                    <span id="loading-spinner" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full ml-2"></span>
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const expenseTableBody = document.getElementById('expense-table-body');
            const addRowButton = document.getElementById('add-row');
            const totalAmountInput = document.getElementById('total-amount');
            const printButton = document.getElementById('print-form');
            const resetButton = document.getElementById('reset-form');
            const mainForm = document.getElementById('reimbursement-form');
            const dateInput = document.getElementById('date');
            
            const generateButton = document.getElementById('generate-items');
            const generateModal = document.getElementById('generate-modal');
            const closeModalButton = document.getElementById('close-modal');
            const promptTextarea = document.getElementById('prompt-textarea');
            const generateSubmitButton = document.getElementById('generate-submit');
            const loadingSpinner = document.getElementById('loading-spinner');
            const generateBtnText = document.getElementById('generate-btn-text');

            const ibanInput = document.getElementById('iban');

            dateInput.valueAsDate = new Date();

            const createRow = (data = {}) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200';
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">
                        <input type="date" class="form-input expense-date" value="${data.datum || new Date().toISOString().slice(0, 10)}">
                    </td>
                    <td class="px-3 py-2">
                        <input type="text" class="form-input expense-description" placeholder="z.B. Büromaterial" value="${data.beschreibung || ''}">
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <input type="number" class="form-input expense-amount text-right" placeholder="0.00" min="0" step="0.01" value="${data.betrag || ''}">
                    </td>
                    <td class="px-3 py-2 text-center no-print">
                        <button type="button" class="btn-danger p-2 rounded-full delete-row">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                
                row.querySelector('.expense-amount').addEventListener('input', calculateTotal);
                row.querySelector('.delete-row').addEventListener('click', (e) => {
                    e.currentTarget.closest('tr').remove();
                    calculateTotal();
                });

                return row;
            };

            ibanInput.addEventListener('input', (e) => {
                const value = e.target.value.replace(/\s/g, '');
                const formattedValue = value.replace(/(.{4})/g, '$1 ').trim();
                e.target.value = formattedValue.toUpperCase();
            });
            
            const calculateTotal = () => {
                let total = 0;
                const amounts = expenseTableBody.querySelectorAll('.expense-amount');
                amounts.forEach(input => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value)) {
                        total += value;
                    }
                });
                totalAmountInput.value = `${total.toFixed(2).replace('.', ',')} €`;
            };

            const appendRowsFromData = (data) => {
                if (!Array.isArray(data) || data.length === 0) {
                    return;
                }
                const currentRows = expenseTableBody.querySelectorAll('tr').length;
                if (currentRows > 1 || (currentRows === 1 && expenseTableBody.querySelector('.expense-amount').value !== '')) {
                    const newRows = document.createDocumentFragment();
                    data.forEach(item => newRows.appendChild(createRow(item)));
                    expenseTableBody.appendChild(newRows);
                } else {
                    expenseTableBody.innerHTML = '';
                    data.forEach(item => expenseTableBody.appendChild(createRow(item)));
                }
                calculateTotal();
            };

            addRowButton.addEventListener('click', () => {
                const newRow = createRow();
                expenseTableBody.appendChild(newRow);
            });

            printButton.addEventListener('click', () => {
                window.print();
            });
            
            resetButton.addEventListener('click', () => {
                mainForm.reset();
                expenseTableBody.innerHTML = '';
                const newRow = createRow();
                expenseTableBody.appendChild(newRow);
                dateInput.valueAsDate = new Date();
                calculateTotal();
            });

            generateButton.addEventListener('click', () => {
                generateModal.style.display = 'block';
            });
            
            closeModalButton.addEventListener('click', () => {
                generateModal.style.display = 'none';
            });
            
            window.addEventListener('click', (event) => {
                if (event.target == generateModal) {
                    generateModal.style.display = 'none';
                }
            });

            generateSubmitButton.addEventListener('click', async () => {
                const userPrompt = promptTextarea.value.trim();
                if (!userPrompt) {
                    return;
                }
                
                generateBtnText.textContent = 'Generiere...';
                loadingSpinner.classList.remove('hidden');
                generateSubmitButton.disabled = true;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: `Extrahiere aus dem folgenden Text die Ausgaben. Gib das Ergebnis als JSON-Array von Objekten zurück. Jedes Objekt soll die Felder "beschreibung" (als String) und "betrag" (als Zahl) haben. Text: "${userPrompt}"` }] });
                
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "beschreibung": { "type": "STRING" },
                                    "betrag": { "type": "NUMBER" }
                                }
                            }
                        }
                    }
                };
                
                let retryCount = 0;
                const maxRetries = 3;
                let responseData;
                let success = false;

                while (retryCount < maxRetries && !success) {
                    try {
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status === 429) {
                            const delay = Math.pow(2, retryCount) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                            continue;
                        }
                        if (!response.ok) {
                            throw new Error(`API response was not ok: ${response.statusText}`);
                        }
                        responseData = await response.json();
                        success = true;
                    } catch (error) {
                        retryCount++;
                        if (retryCount >= maxRetries) {
                            console.error('An error occurred while calling the API:', error);
                            alert('Es gab ein Problem beim Generieren der Ausgaben. Bitte versuche es später noch einmal.');
                        }
                    }
                }

                generateBtnText.textContent = 'Generieren';
                loadingSpinner.classList.add('hidden');
                generateSubmitButton.disabled = false;
                generateModal.style.display = 'none';

                if (success && responseData.candidates && responseData.candidates.length > 0 && responseData.candidates[0].content && responseData.candidates[0].content.parts && responseData.candidates[0].content.parts.length > 0) {
                    try {
                        const jsonString = responseData.candidates[0].content.parts[0].text;
                        const parsedData = JSON.parse(jsonString);
                        appendRowsFromData(parsedData);
                    } catch (e) {
                        console.error('Failed to parse JSON from API:', e);
                        alert('Die generierten Daten konnten nicht verarbeitet werden. Bitte versuche es mit einer anderen Beschreibung.');
                    }
                } else {
                    alert('Es wurden keine Ausgaben gefunden. Versuche eine detailliertere Beschreibung.');
                }
                
                promptTextarea.value = '';
            });

            const newRow = createRow();
            expenseTableBody.appendChild(newRow);
        });
    </script>
</body>
</html>
